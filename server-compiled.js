(()=>{"use strict";const e=require("mongodb"),a=require("express"),o=require("multer"),i=require("path"),t=require("url"),n=(require("os"),require("sanitize-html")),s=(require("process"),require("fs-extra")),l=require("sharp"),d=(require("console"),a());let r;const c=o(),p=(0,t.fileURLToPath)("file:///D:/Projects/CodeFolder/NODE%20JS/puppy-app/server.js"),u=i.dirname(p);d.use(a.static(i.join(u,"public"))),s.ensureDirSync(i.join("public","uploaded-photos")),d.set("view engine","ejs"),d.set("views","./views"),d.use(a.json()),d.use(a.urlencoded({extended:!1}));const m=(e,a,o)=>{console.log(e.headers.authorization),a.set("WWW-Authenticate","Basic realm='Our MERN App'"),"Basic YWRtaW46YWRtaW4="==e.headers.authorization?o():a.status(401).send('\n        <nav>\n          <a href="/">Home</a> { }\n          <a href="/admin">Admin</a>\n        </nav>\n        Try again\n    ')},b=async(e,a,o)=>{"string"!=typeof e.body.name&&(e.body.name=""),"string"!=typeof e.body.species&&(e.body.species=""),"string"!=typeof e.body._id&&(e.body._id=""),e.cleanData={name:n(e.body.name.trim(),{allowedTags:[],allowedAttributes:{}}),species:n(e.body.species.trim(),{allowedTags:[],allowedAttributes:{}})},o()};d.get("/",((e,a)=>{a.render("home")})),d.get("/admin",m,((e,a)=>{a.render("admin")})),d.get("/api/animals",(async(e,a)=>{const o=await r.collection("animals").find().toArray();a.json(o)})),d.post("/create-animal",m,c.single("photo"),b,(async(a,o)=>{if(a.file){const e=`${Date.now()}.jpg`;await l(a.file.buffer).resize(844,456).jpeg({quality:60}).toFile(i.join("public","uploaded-photos",e)),a.cleanData.photo=e}const t=await r.collection("animals").insertOne(a.cleanData),n=await r.collection("animals").findOne({_id:new e.ObjectId(t.insertedId)});o.send(n)})),d.delete("/animal/:id",m,(async(a,o)=>{"string"!=typeof a.params.id&&(a.params.id="");const t=await r.collection("animals").findOne({_id:new e.ObjectId(a.params.id)});t.photo&&s.remove(i.join("public","uploaded-photos",t.photo)),r.collection("animals").deleteOne({_id:new e.ObjectId(a.params.id)}),o.send("Pet was deleted from your collection")})),d.post("/update-animal",m,c.single("photo"),b,(async(a,o)=>{if(a.file){const t=`${Date.now()}.jpg`;await l(a.file.buffer).resize(844,456).jpeg({quality:60}).toFile(i.join("public","uploaded-photos",t)),a.cleanData.photo=t;const n=await r.collection("animals").findOneAndUpdate({_id:new e.ObjectId(a.body._id)},{$set:a.cleanData});n.value.photo&&s.remove(i.join("public","uploaded-photos",n.value.photo)),o.send(t)}else r.collection("animals").findOneAndUpdate({_id:new e.ObjectId(a.body._id)},{$set:a.cleanData}),o.send(!1)})),(async()=>{const a=new e.MongoClient("mongodb://localhost:27017/puppy-app");await a.connect(),r=a.db(),d.listen(3e3,(()=>{console.log("http://localhost:3000")}))})()})();